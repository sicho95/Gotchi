<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamagotchi Original</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        /* Menu hamburger */
        .hamburger-menu {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
        }

        .hamburger-btn {
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 10px;
            width: 45px;
            height: 45px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding: 10px;
            outline: none;
        }

        .hamburger-btn:active {
            transform: scale(0.95);
        }

        .hamburger-btn span {
            width: 22px;
            height: 2.5px;
            background: #333;
            border-radius: 2px;
            transition: 0.3s;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 55px;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            min-width: 220px;
            overflow: hidden;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-section-title {
            padding: 10px 15px;
            background: #f0f0f0;
            font-weight: bold;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .menu-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            outline: none;
        }

        .menu-item:hover {
            background: #f8f8f8;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: 0.2s;
            outline: none;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        .color-option:active {
            transform: scale(0.95);
        }

        input[type="file"] {
            display: none;
        }

        /* Device Tamagotchi */
        .tamagotchi-device {
            background: var(--shell-color, linear-gradient(145deg, #6a5acd, #483d8b));
            border-radius: 48% 48% 50% 50% / 42% 42% 45% 45%;
            padding: 20px 18px 35px 18px;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.35),
                inset 0 -5px 20px rgba(0,0,0,0.2),
                inset 0 2px 10px rgba(255,255,255,0.2);
            max-width: 300px;
            width: 100%;
            position: relative;
            transition: background 0.3s ease;
        }

        .tamagotchi-device::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #e0e0e0, #999);
            border-radius: 50%;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
        }

        .logo-area {
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 16px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }

        /* √âcran LCD */
        .screen-wrapper {
            background: linear-gradient(145deg, #ddd, #bbb);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 18px;
            box-shadow: 
                inset 0 2px 6px rgba(0,0,0,0.25),
                0 1px 3px rgba(255,255,255,0.4);
        }

        .screen-border {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 6px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.9);
        }

        .screen {
            background: #8ba446;
            width: 100%;
            height: 180px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.2);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .screen.light-off {
            background: #3d4a1f;
        }

        /* Ic√¥nes de menu en pixel art */
        .menu-icons {
            display: flex;
            justify-content: space-around;
            padding: 4px 6px;
            background: rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .menu-icon {
            width: 16px;
            height: 16px;
            position: relative;
            cursor: pointer;
            opacity: 0.35;
            transition: opacity 0.2s;
        }

        .menu-icon.selected {
            opacity: 1;
        }

        .menu-icon::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 3px solid transparent;
            border-right: 3px solid transparent;
            border-bottom: 3px solid rgba(0,0,0,0.6);
            opacity: 0;
        }

        .menu-icon.selected::after {
            opacity: 1;
        }

        /* Pixel art icons */
        .icon-food {
            background: 
                linear-gradient(to right, transparent 4px, #000 4px, #000 5px, transparent 5px, transparent 6px, #000 6px, #000 10px, transparent 10px),
                linear-gradient(to right, transparent 3px, #000 3px, #000 11px, transparent 11px),
                linear-gradient(to right, transparent 2px, #000 2px, #000 12px, transparent 12px),
                linear-gradient(to right, transparent 2px, #000 2px, #000 12px, transparent 12px);
            background-size: 100% 2px, 100% 2px, 100% 2px, 100% 8px;
            background-position: 0 2px, 0 4px, 0 6px, 0 8px;
            background-repeat: no-repeat;
        }

        .icon-light {
            background: radial-gradient(circle at center, #000 30%, transparent 30%);
        }

        .icon-game {
            background: 
                linear-gradient(to right, transparent 6px, #000 6px, #000 8px, transparent 8px),
                linear-gradient(to right, #000 2px, transparent 2px, transparent 12px, #000 12px);
            background-size: 100% 4px, 100% 8px;
            background-position: 0 4px, 0 8px;
            background-repeat: no-repeat;
        }

        .icon-health {
            width: 14px;
            height: 14px;
            background: 
                linear-gradient(45deg, transparent 6px, #000 6px, #000 8px, transparent 8px),
                linear-gradient(-45deg, transparent 6px, #000 6px, #000 8px, transparent 8px),
                linear-gradient(to bottom, transparent 8px, #000 8px);
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        .icon-toilet {
            background: 
                linear-gradient(to right, transparent 5px, #000 5px, #000 9px, transparent 9px),
                linear-gradient(to right, transparent 4px, #000 4px, #000 10px, transparent 10px),
                linear-gradient(to right, transparent 2px, #000 2px, #000 12px, transparent 12px);
            background-size: 100% 3px, 100% 4px, 100% 3px;
            background-position: 0 2px, 0 5px, 0 12px;
            background-repeat: no-repeat;
        }

        .icon-stats {
            background: 
                linear-gradient(to right, #000 2px, transparent 2px, transparent 12px, #000 12px),
                linear-gradient(to right, #000 100%),
                linear-gradient(to right, #000 100%);
            background-size: 100% 2px, 8px 2px, 8px 2px;
            background-position: 0 3px, 3px 7px, 3px 11px;
            background-repeat: no-repeat;
        }

        .icon-discipline {
            background: 
                linear-gradient(135deg, transparent 6px, #000 6px, #000 8px, transparent 8px),
                linear-gradient(to bottom, transparent 6px, #000 6px, #000 14px, transparent 14px);
            background-size: 100% 100%, 2px 100%;
            background-position: 0 0, 7px 0;
            background-repeat: no-repeat;
        }

        /* Zone de jeu */
        .game-area {
            height: 135px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .pet {
            font-size: 52px;
            animation: bounce 2.5s ease-in-out infinite;
            filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.25));
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.03); }
        }

        .skull {
            animation: fade 1.8s ease-in-out infinite;
        }

        @keyframes fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.25; }
        }

        .poop {
            position: absolute;
            font-size: 18px;
            bottom: 12px;
        }

        .hearts-display {
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 9px;
            line-height: 1.3;
            font-weight: bold;
        }

        .heart-line {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .info-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #8ba446;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .info-overlay.active {
            display: flex;
        }

        .info-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            padding: 2px 4px;
        }

        .feed-menu, .game-screen {
            display: none;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
            align-items: center;
        }

        .feed-menu.active, .game-screen.active {
            display: flex;
        }

        .feed-option {
            font-size: 32px;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.4;
            transition: 0.2s;
        }

        .feed-option.selected {
            opacity: 1;
            background: rgba(0,0,0,0.08);
        }

        .message-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.92);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 11px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: none;
            z-index: 10;
        }

        .message-popup.active {
            display: block;
        }

        .sleep-zzz {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 22px;
            animation: float 2.2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .age-info {
            position: absolute;
            bottom: 6px;
            right: 6px;
            font-size: 9px;
            font-weight: bold;
        }

        .game-options {
            display: flex;
            gap: 18px;
        }

        .game-choice {
            font-size: 36px;
            opacity: 0.35;
            transition: 0.2s;
        }

        .game-choice.selected {
            opacity: 1;
            animation: pulse 0.6s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Boutons int√©gr√©s */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 28px;
            margin-top: 20px;
        }

        .tama-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            box-shadow: 
                0 4px 0 rgba(0,0,0,0.3),
                0 6px 12px rgba(0,0,0,0.15),
                inset 0 -2px 6px rgba(0,0,0,0.2),
                inset 0 1px 3px rgba(255,255,255,0.3);
            position: relative;
            top: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tama-btn:active {
            top: 3px;
            box-shadow: 
                0 1px 0 rgba(0,0,0,0.3),
                0 2px 6px rgba(0,0,0,0.15),
                inset 0 -2px 6px rgba(0,0,0,0.2);
        }

        .btn-a {
            background: radial-gradient(circle at 35% 35%, #ffd700, #daa520);
        }

        .btn-b {
            background: radial-gradient(circle at 35% 35%, #ff6b9d, #d94f7a);
        }

        .btn-c {
            background: radial-gradient(circle at 35% 35%, #4fc3f7, #0288d1);
        }

        .btn-label {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: bold;
            color: rgba(255,255,255,0.9);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            white-space: nowrap;
        }

        @media (max-width: 400px) {
            .tamagotchi-device {
                max-width: 280px;
            }
            .control-buttons {
                gap: 22px;
            }
            .tama-btn {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- Menu Hamburger -->
    <div class="hamburger-menu">
        <button class="hamburger-btn" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="menu-dropdown" id="menu-dropdown">
            <div class="menu-section-title">üé® Couleur de Coque</div>
            <div class="color-grid">
                <div class="color-option selected" style="background: linear-gradient(145deg, #6a5acd, #483d8b);" data-color="purple" title="Violet"></div>
                <div class="color-option" style="background: linear-gradient(145deg, #ff69b4, #ff1493);" data-color="pink" title="Rose"></div>
                <div class="color-option" style="background: linear-gradient(145deg, rgba(255,182,193,0.7), rgba(255,105,180,0.7)); backdrop-filter: blur(10px);" data-color="pink-trans" title="Rose Transparent"></div>
                <div class="color-option" style="background: linear-gradient(145deg, #4169e1, #1e3a8a);" data-color="blue" title="Bleu"></div>
                <div class="color-option" style="background: linear-gradient(145deg, #ffd700, #ff8c00);" data-color="yellow" title="Jaune"></div>
                <div class="color-option" style="background: linear-gradient(145deg, rgba(127,255,212,0.6), rgba(64,224,208,0.6));" data-color="green-trans" title="Vert Transparent"></div>
                <div class="color-option" style="background: linear-gradient(145deg, #ff4500, #dc143c);" data-color="red" title="Rouge"></div>
                <div class="color-option" style="background: linear-gradient(145deg, #f0f0f0, #c0c0c0);" data-color="white" title="Blanc"></div>
                <div class="color-option" style="background: linear-gradient(145deg, #32cd32, #228b22);" data-color="green" title="Vert"></div>
            </div>
            <div class="menu-section-title">üíæ Sauvegarde</div>
            <div class="menu-item" onclick="exportToJSON()">
                üì• Exporter JSON
            </div>
            <label class="menu-item" for="import-file">
                üì§ Importer JSON
            </label>
            <div class="menu-item" onclick="resetPet()">
                üîÑ Nouveau Tamagotchi
            </div>
        </div>
    </div>
    <input type="file" id="import-file" accept=".json" onchange="importFromJSON(event)">

    <!-- Device Tamagotchi -->
    <div class="tamagotchi-device" id="device">
        <div class="logo-area">Tamagotchi</div>

        <div class="screen-wrapper">
            <div class="screen-border">
                <div class="screen" id="screen">
                    <!-- Ic√¥nes de menu en pixel art -->
                    <div class="menu-icons">
                        <div class="menu-icon icon-food" data-index="0" title="Nourrir"></div>
                        <div class="menu-icon icon-light" data-index="1" title="Lumi√®re"></div>
                        <div class="menu-icon icon-game" data-index="2" title="Jouer"></div>
                        <div class="menu-icon icon-health" data-index="3" title="Soigner"></div>
                        <div class="menu-icon icon-toilet" data-index="4" title="Nettoyer"></div>
                        <div class="menu-icon icon-stats" data-index="5" title="Stats"></div>
                        <div class="menu-icon icon-discipline" data-index="6" title="Discipline"></div>
                    </div>

                    <!-- Zone principale -->
                    <div class="game-area" id="game-area">
                        <div class="hearts-display">
                            <div class="heart-line">
                                <span>üçñ</span>
                                <span id="hunger-hearts"></span>
                            </div>
                            <div class="heart-line">
                                <span>üòä</span>
                                <span id="happy-hearts"></span>
                            </div>
                        </div>
                        <div class="pet" id="pet">ü•ö</div>
                        <div class="age-info" id="age-info">0h</div>
                    </div>

                    <!-- Menu Feed -->
                    <div class="feed-menu" id="feed-menu">
                        <div class="feed-option" data-type="meal">üçñ</div>
                        <div class="feed-option" data-type="snack">üç∞</div>
                    </div>

                    <!-- √âcran Stats -->
                    <div class="info-overlay" id="stats-screen">
                        <div class="info-row"><span>√ÇGE:</span><span id="stat-age">0h</span></div>
                        <div class="info-row"><span>POIDS:</span><span id="stat-weight">5g</span></div>
                        <div class="info-row"><span>SANT√â:</span><span id="stat-health">100%</span></div>
                        <div class="info-row"><span>STADE:</span><span id="stat-stage">≈íuf</span></div>
                    </div>

                    <!-- √âcran Discipline -->
                    <div class="info-overlay" id="disc-screen">
                        <div class="info-row"><span>DISCIPLINE</span></div>
                        <div class="info-row"><span id="disc-value">0%</span></div>
                    </div>

                    <!-- √âcran de jeu -->
                    <div class="game-screen" id="game-screen">
                        <div style="font-size: 12px; font-weight: bold;">GAUCHE ou DROITE?</div>
                        <div class="game-options">
                            <div class="game-choice" data-dir="left">‚¨ÖÔ∏è</div>
                            <div class="game-choice" data-dir="right">‚û°Ô∏è</div>
                        </div>
                    </div>

                    <!-- Message popup -->
                    <div class="message-popup" id="message-popup"></div>
                </div>
            </div>
        </div>

        <!-- Boutons A, B, C -->
        <div class="control-buttons">
            <button class="tama-btn btn-a" onclick="handleButtonA()">
                A
                <span class="btn-label">SELECT</span>
            </button>
            <button class="tama-btn btn-b" onclick="handleButtonB()">
                B
                <span class="btn-label">DECIDE</span>
            </button>
            <button class="tama-btn btn-c" onclick="handleButtonC()">
                C
                <span class="btn-label">CANCEL</span>
            </button>
        </div>
    </div>

    <script>
        const shellColors = {
            purple: 'linear-gradient(145deg, #6a5acd, #483d8b)',
            pink: 'linear-gradient(145deg, #ff69b4, #ff1493)',
            'pink-trans': 'linear-gradient(145deg, rgba(255,182,193,0.8), rgba(255,105,180,0.8))',
            blue: 'linear-gradient(145deg, #4169e1, #1e3a8a)',
            yellow: 'linear-gradient(145deg, #ffd700, #ff8c00)',
            'green-trans': 'linear-gradient(145deg, rgba(127,255,212,0.7), rgba(64,224,208,0.7))',
            red: 'linear-gradient(145deg, #ff4500, #dc143c)',
            white: 'linear-gradient(145deg, #f0f0f0, #c0c0c0)',
            green: 'linear-gradient(145deg, #32cd32, #228b22)'
        };

        let currentShell = 'purple';

        let tamagotchi = {
            stage: 'egg',
            age: 0,
            hunger: 4,
            happiness: 4,
            weight: 5,
            discipline: 0,
            health: 100,
            isSick: false,
            poopCount: 0,
            isSleeping: false,
            lightOn: true,
            lastUpdate: Date.now(),
            birthTime: Date.now(),
            careErrors: 0
        };

        const stageSprites = {
            egg: 'ü•ö', baby: 'üê£', child: 'üê•', 
            teen: 'üê§', adult: 'üê¶', good_adult: 'ü¶ú', 
            perfect_adult: 'ü¶ö', dead: 'üíÄ'
        };

        const stageNames = {
            egg: '≈íuf', baby: 'B√©b√©', child: 'Enfant',
            teen: 'Ado', adult: 'Adulte', good_adult: 'Bon',
            perfect_adult: 'Parfait', dead: 'Mort'
        };

        let currentMenu = -1;
        let currentSubMenu = 0;
        let gameCorrectAnswer = '';

        // S√©lection de couleur
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                currentShell = this.dataset.color;
                document.getElementById('device').style.background = shellColors[currentShell];
                localStorage.setItem('shellColor', currentShell);
            });
        });

        function toggleMenu() {
            document.getElementById('menu-dropdown').classList.toggle('active');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.hamburger-menu')) {
                document.getElementById('menu-dropdown').classList.remove('active');
            }
        });

        function handleButtonA() {
            if (currentMenu === -1) {
                currentMenu = 0;
                updateMenuSelection();
            } else if (currentMenu === 0) {
                currentSubMenu = (currentSubMenu + 1) % 2;
                updateFeedSelection();
            } else if (currentMenu === 2) {
                currentSubMenu = (currentSubMenu + 1) % 2;
                updateGameSelection();
            } else {
                currentMenu = (currentMenu + 1) % 7;
                closeAllScreens();
                updateMenuSelection();
            }
        }

        function handleButtonB() {
            if (currentMenu === -1) {
                currentMenu = 0;
                updateMenuSelection();
            } else {
                executeMenuAction();
            }
        }

        function handleButtonC() {
            currentMenu = -1;
            currentSubMenu = 0;
            closeAllScreens();
            updateMenuSelection();
        }

        function updateMenuSelection() {
            const icons = document.querySelectorAll('.menu-icon');
            icons.forEach((icon, index) => {
                icon.classList.toggle('selected', index === currentMenu);
            });
        }

        function closeAllScreens() {
            document.getElementById('feed-menu').classList.remove('active');
            document.getElementById('stats-screen').classList.remove('active');
            document.getElementById('disc-screen').classList.remove('active');
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('game-area').style.display = 'flex';
        }

        function executeMenuAction() {
            if (tamagotchi.stage === 'dead') {
                showMessage('üíÄ RIP');
                return;
            }

            switch(currentMenu) {
                case 0:
                    if (!document.getElementById('feed-menu').classList.contains('active')) {
                        closeAllScreens();
                        document.getElementById('game-area').style.display = 'none';
                        document.getElementById('feed-menu').classList.add('active');
                        updateFeedSelection();
                    } else {
                        currentSubMenu === 0 ? feed() : giveSnack();
                        handleButtonC();
                    }
                    break;
                case 1: toggleLight(); break;
                case 2:
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        startGame();
                    } else {
                        playGame();
                    }
                    break;
                case 3: giveMedicine(); break;
                case 4: clean(); break;
                case 5:
                    closeAllScreens();
                    document.getElementById('stats-screen').classList.add('active');
                    updateStatsDisplay();
                    break;
                case 6:
                    closeAllScreens();
                    document.getElementById('disc-screen').classList.add('active');
                    document.getElementById('disc-value').textContent = tamagotchi.discipline + '%';
                    break;
            }
        }

        function updateFeedSelection() {
            const options = document.querySelectorAll('.feed-option');
            options.forEach((opt, index) => {
                opt.classList.toggle('selected', index === currentSubMenu);
            });
        }

        function startGame() {
            if (tamagotchi.stage === 'egg' || tamagotchi.isSleeping) {
                showMessage('Impossible');
                return;
            }
            closeAllScreens();
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            gameCorrectAnswer = Math.random() < 0.5 ? 'left' : 'right';
            currentSubMenu = 0;
            updateGameSelection();
        }

        function updateGameSelection() {
            const choices = document.querySelectorAll('.game-choice');
            choices.forEach((choice, index) => {
                choice.classList.toggle('selected', index === currentSubMenu);
            });
        }

        function playGame() {
            const playerChoice = currentSubMenu === 0 ? 'left' : 'right';
            const won = playerChoice === gameCorrectAnswer;

            if (won) {
                tamagotchi.happiness = Math.min(4, tamagotchi.happiness + 1);
                tamagotchi.weight = Math.max(1, tamagotchi.weight - 1);
                tamagotchi.discipline = Math.min(100, tamagotchi.discipline + 5);
                showMessage('üéâ GAGN√â!');
            } else {
                showMessage('üò¢ PERDU');
            }

            handleButtonC();
            updateDisplay();
            saveToLocalStorage();
        }

        function feed() {
            if (tamagotchi.hunger < 4) {
                tamagotchi.hunger = Math.min(4, tamagotchi.hunger + 1);
                tamagotchi.weight += 1;
                showMessage('üçñ Miam!');
                updateDisplay();
                saveToLocalStorage();
            } else {
                showMessage('Pas faim');
            }
        }

        function giveSnack() {
            if (tamagotchi.happiness < 4) {
                tamagotchi.happiness = Math.min(4, tamagotchi.happiness + 1);
                tamagotchi.weight += 2;
                showMessage('üç∞ Yum!');
                updateDisplay();
                saveToLocalStorage();
            } else {
                showMessage('Assez!');
            }
        }

        function clean() {
            if (tamagotchi.poopCount > 0) {
                tamagotchi.poopCount = 0;
                showMessage('‚ú® Propre!');
                updateDisplay();
                saveToLocalStorage();
            } else {
                showMessage('D√©j√† propre');
            }
        }

        function giveMedicine() {
            if (tamagotchi.isSick) {
                tamagotchi.isSick = false;
                tamagotchi.health = Math.min(100, tamagotchi.health + 20);
                showMessage('üíä Gu√©ri!');
                updateDisplay();
                saveToLocalStorage();
            } else {
                showMessage('Pas malade');
            }
        }

        function toggleLight() {
            tamagotchi.lightOn = !tamagotchi.lightOn;
            if (!tamagotchi.lightOn) {
                tamagotchi.isSleeping = true;
                showMessage('üí§ Dodo');
            } else {
                const hour = new Date().getHours();
                if (hour < 21 && hour >= 8) {
                    tamagotchi.isSleeping = false;
                }
                showMessage('üí° Allum√©');
            }
            updateDisplay();
            saveToLocalStorage();
        }

        function showMessage(msg) {
            const popup = document.getElementById('message-popup');
            popup.textContent = msg;
            popup.classList.add('active');
            setTimeout(() => popup.classList.remove('active'), 1500);
        }

        function updateDisplay() {
            const hungerEl = document.getElementById('hunger-hearts');
            const happyEl = document.getElementById('happy-hearts');
            hungerEl.innerHTML = '‚ô•'.repeat(tamagotchi.hunger) + '‚ô°'.repeat(4 - tamagotchi.hunger);
            happyEl.innerHTML = '‚ô•'.repeat(tamagotchi.happiness) + '‚ô°'.repeat(4 - tamagotchi.happiness);

            const petEl = document.getElementById('pet');
            const gameArea = document.getElementById('game-area');

            document.querySelectorAll('.poop').forEach(p => p.remove());
            document.querySelectorAll('.sleep-zzz').forEach(s => s.remove());

            if (tamagotchi.stage === 'dead') {
                petEl.textContent = stageSprites.dead;
                petEl.className = 'pet skull';
            } else {
                petEl.textContent = tamagotchi.isSick ? 'ü§í' : stageSprites[tamagotchi.stage];
                petEl.className = 'pet';

                for (let i = 0; i < tamagotchi.poopCount; i++) {
                    const poop = document.createElement('div');
                    poop.className = 'poop';
                    poop.textContent = 'üí©';
                    poop.style.left = (10 + i * 20) + '%';
                    gameArea.appendChild(poop);
                }

                if (tamagotchi.isSleeping) {
                    const zzz = document.createElement('div');
                    zzz.className = 'sleep-zzz';
                    zzz.textContent = 'Zzz';
                    gameArea.appendChild(zzz);
                }
            }

            document.getElementById('screen').classList.toggle('light-off', !tamagotchi.lightOn);
            document.getElementById('age-info').textContent = tamagotchi.age + 'h';
        }

        function updateStatsDisplay() {
            document.getElementById('stat-age').textContent = tamagotchi.age + 'h';
            document.getElementById('stat-weight').textContent = tamagotchi.weight + 'g';
            document.getElementById('stat-health').textContent = tamagotchi.health + '%';
            document.getElementById('stat-stage').textContent = stageNames[tamagotchi.stage];
        }

        function gameLoop() {
            if (tamagotchi.stage === 'dead') return;

            const now = Date.now();
            const minutesPassed = Math.floor((now - tamagotchi.lastUpdate) / 60000);

            if (minutesPassed > 0 && tamagotchi.stage !== 'egg') {
                if (!tamagotchi.isSleeping) {
                    if (minutesPassed >= 5) tamagotchi.hunger = Math.max(0, tamagotchi.hunger - 1);
                    if (minutesPassed >= 7) tamagotchi.happiness = Math.max(0, tamagotchi.happiness - 1);
                    if (Math.random() < 0.3 && tamagotchi.poopCount < 4) tamagotchi.poopCount++;
                    if (tamagotchi.poopCount >= 2 && Math.random() < 0.4) {
                        tamagotchi.isSick = true;
                        tamagotchi.health = Math.max(0, tamagotchi.health - 10);
                    }
                    if (tamagotchi.health <= 0) tamagotchi.stage = 'dead';
                    if (tamagotchi.hunger === 0 || tamagotchi.happiness === 0) {
                        tamagotchi.careErrors++;
                        tamagotchi.health = Math.max(0, tamagotchi.health - 5);
                    }
                }
                tamagotchi.lastUpdate = now;
            }

            checkAge();
            checkEvolution();
            updateDisplay();
            saveToLocalStorage();
        }

        function checkAge() {
            tamagotchi.age = Math.floor((Date.now() - tamagotchi.birthTime) / 3600000);
        }

        function checkEvolution() {
            if (tamagotchi.stage === 'egg' && tamagotchi.age >= 0.02) {
                tamagotchi.stage = 'baby';
                showMessage('‚ú® B√âB√â!');
            } else if (tamagotchi.stage === 'baby' && tamagotchi.age >= 1) {
                tamagotchi.stage = 'child';
                showMessage('‚ú® ENFANT!');
            } else if (tamagotchi.stage === 'child' && tamagotchi.age >= 3) {
                tamagotchi.stage = 'teen';
                showMessage('‚ú® ADO!');
            } else if (tamagotchi.stage === 'teen' && tamagotchi.age >= 5) {
                if (tamagotchi.careErrors === 0 && tamagotchi.discipline >= 75) {
                    tamagotchi.stage = 'perfect_adult';
                } else if (tamagotchi.careErrors <= 2) {
                    tamagotchi.stage = 'good_adult';
                } else {
                    tamagotchi.stage = 'adult';
                }
                showMessage('‚ú® ADULTE!');
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('tamagotchi', JSON.stringify(tamagotchi));
        }

        function loadFromLocalStorage() {
            const savedShell = localStorage.getItem('shellColor');
            if (savedShell && shellColors[savedShell]) {
                currentShell = savedShell;
                document.getElementById('device').style.background = shellColors[currentShell];
                document.querySelectorAll('.color-option').forEach(o => {
                    o.classList.toggle('selected', o.dataset.color === currentShell);
                });
            }

            const saved = localStorage.getItem('tamagotchi');
            if (saved) {
                tamagotchi = JSON.parse(saved);
                const now = Date.now();
                const minutesPassed = Math.floor((now - tamagotchi.lastUpdate) / 60000);

                if (minutesPassed > 0 && tamagotchi.stage !== 'dead' && tamagotchi.stage !== 'egg') {
                    tamagotchi.hunger = Math.max(0, tamagotchi.hunger - Math.floor(minutesPassed / 5));
                    tamagotchi.happiness = Math.max(0, tamagotchi.happiness - Math.floor(minutesPassed / 7));
                    tamagotchi.poopCount = Math.min(4, tamagotchi.poopCount + Math.floor(minutesPassed / 30));

                    if (tamagotchi.poopCount >= 2 && minutesPassed > 60) {
                        tamagotchi.isSick = true;
                        tamagotchi.health = Math.max(0, tamagotchi.health - 20);
                    }

                    if (minutesPassed > 300 && tamagotchi.hunger === 0) {
                        tamagotchi.stage = 'dead';
                        tamagotchi.health = 0;
                    }
                }
                tamagotchi.lastUpdate = now;
            }
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(tamagotchi, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tamagotchi_${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showMessage('üíæ Export√©!');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    tamagotchi = JSON.parse(e.target.result);
                    tamagotchi.lastUpdate = Date.now();
                    saveToLocalStorage();
                    updateDisplay();
                    showMessage('üìÇ Import√©!');
                } catch {
                    alert('Fichier invalide');
                }
            };
            reader.readAsText(file);
        }

        function resetPet() {
            if (confirm('Nouveau Tamagotchi?')) {
                tamagotchi = {
                    stage: 'egg', age: 0, hunger: 4, happiness: 4,
                    weight: 5, discipline: 0, health: 100, isSick: false,
                    poopCount: 0, isSleeping: false, lightOn: true,
                    lastUpdate: Date.now(), birthTime: Date.now(), careErrors: 0
                };
                saveToLocalStorage();
                updateDisplay();
                showMessage('ü•ö Nouveau!');
            }
        }

        window.onload = () => {
            loadFromLocalStorage();
            updateDisplay();
            setInterval(gameLoop, 30000);
        };
    </script>
</body>
</html>